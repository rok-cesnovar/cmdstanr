context("model-dir")

if (not_on_cran()) {
  set_cmdstan_path()
  if (getRversion() < '3.5.0') {
    sandbox <- file.path(tempdir(), "sandbox")
  } else {
    sandbox <- file.path(tempdir(check = TRUE), "sandbox")
  }
  if (!dir.exists(sandbox)) {
    dir.create(sandbox)
  }
}

test_that("all fitting methods work with dir", {
  skip_on_cran()
  for (method in c("sample", "optimize", "variational")) {
    method_dir <- file.path(sandbox, method)
    if (!dir.exists(method_dir)) {
      dir.create(method_dir)
    }

    # no dir means should use tempdir
    fit <- testing_fit("bernoulli", method = method, seed = 123)
    expect_equal(fit$runset$args$dir, absolute_path(tempdir()))

    # specifying dir
    fit <- testing_fit("bernoulli", method = method, seed = 123,
                        dir = method_dir)
    expect_equal(fit$runset$args$dir, absolute_path(method_dir))
    expect_equal(length(list.files(method_dir)), fit$num_procs())
  }

  # specifying dir and save_latent_dynamics
  fit <- testing_fit("bernoulli", method = "sample", seed = 123,
                     dir = file.path(sandbox, "sample"),
                     save_latent_dynamics = TRUE)

  files <- list.files(file.path(sandbox, "sample"))
  expect_equal(
    sum(grepl("diagnostic", files)),
    fit$num_procs()
  )
})

test_that("error if dir is invalid", {
  skip_on_cran()

  expect_error(
    testing_fit("bernoulli", dir = "NOT_A_DIR"),
    "Directory 'NOT_A_DIR' does not exist",
    fixed = TRUE
  )
  expect_error(
    testing_fit("bernoulli", dir = TRUE),
    "No directory provided"
  )

  if (!os_is_windows()) {
    # FIXME: how do I create an unreadable file on windows?
    not_readable <- file.path(sandbox, "locked")
    dir.create(not_readable, mode = "220")
    expect_error(
      testing_fit("bernoulli", dir = not_readable),
      "not readable"
    )
  }
  file.remove(list.files(sandbox, full.names = TRUE, recursive = TRUE))
})

test_that("dir works with trailing /", {
  skip_on_cran()
  test_dir <- file.path(sandbox, "trailing")
  dir.create(test_dir)
  fit <- testing_fit(
    "bernoulli",
    method = "sample",
    seed = 123,
    dir = paste0(test_dir,"/")
  )
  expect_equal(fit$runset$args$dir, absolute_path(test_dir))
  expect_equal(length(list.files(test_dir)), fit$num_procs())
})
